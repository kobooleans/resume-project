<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ks.resumeproject.portfolio.repository.PortfolioMapper">

    <select id="categoryList" parameterType="AccountDto" resultType="CategoryDto">
        <![CDATA[
            SELECT CATEGORY_ID
                 , ID
                 , RANDOM_ID
                 , CATEGORY_NM
            FROM CATEGORY
            WHERE ID = #{id}
              AND RANDOM_ID = #{randomId}
            ORDER BY CATEGORY_ID
        ]]>
    </select>

    <insert id="insertCategory" parameterType="CategoryDto">
        <![CDATA[
            INSERT INTO CATEGORY
                 ( CATEGORY_ID
                 , ID
                 , RANDOM_ID
                 , CATEGORY_NM)
            SELECT COALESCE(NULLIF(MAX(CATEGORY_ID), 0), 0) + 1
                 , #{id}
                 , #{randomId}
                 , #{categoryNm}
            FROM CATEGORY
            WHERE ID = #{id}
              AND RANDOM_ID = #{randomId}
            ORDER BY MAX(CATEGORY_ID) DESC
        ]]>
    </insert>

    <update id="updateCategory" parameterType="CategoryDto">
        <![CDATA[
            UPDATE CATEGORY
               SET CATEGORY_NM	= #{categoryNm}
             WHERE CATEGORY_ID	= #{categoryId}
               AND ID			= #{id}
               AND RANDOM_ID	= #{randomId}
        ]]>
    </update>

    <delete id="deleteCategory" parameterType="CategoryDto">
        <![CDATA[
            DELETE FROM CATEGORY
             WHERE CATEGORY_ID	= #{categoryId}
               AND ID			= #{id}
               AND RANDOM_ID	= #{randomId}
        ]]>
    </delete>

    <select id="portfolioAllList" parameterType="PortfolioDto" resultType="PortfolioDto">
        <![CDATA[
            SELECT ID
                 , RANDOM_ID
                 , PORT_ID
                 , TITLE
                 , CONTENT
                 , CATEGORY_ID
                 , FILE_ID
                 , START_YMD
                 , END_YMD
            FROM PORTFOLIO
            WHERE ID        = #{id}
              AND RANDOM_ID = #{randomId}
        ]]>
        <if test="categoryId != 0">
              AND CATEGORY_ID = #{categoryId}
        </if>
            ORDER BY PORT_ID
    </select>

    <select id="selectMaxPortId" parameterType="PortfolioDto" resultType="java.math.BigInteger">
        <![CDATA[
            SELECT COALESCE(NULLIF(MAX(PORT_ID), 0), 0) + 1
              FROM PORTFOLIO
             WHERE ID 			= #{id}
               AND RANDOM_ID 	= #{randomId}
        ]]>
    </select>

    <insert id="insertPortfolio" parameterType="PortfolioDto">
        <![CDATA[
        INSERT INTO PORTFOLIO
             ( ID
             , RANDOM_ID
             , PORT_ID
             , TITLE
             , CONTENT
             , CATEGORY_ID
             , FILE_ID
             , START_YMD
             , END_YMD
             )
        VALUES
             ( #{id}
             , #{randomId}
             , #{portId}
             , #{title}
             , #{content}
             , #{categoryId}
             , #{fileId}
             , #{startYmd}
             , #{endYmd}
             )
        ]]>
    </insert>

    <insert id="insertPortfolioDetail" parameterType="PortfolioDetailDto">
        <![CDATA[
            INSERT INTO PORTFOLIO_DETAIL
                 ( DETAIL_ID
                 , ID
                 , RANDOM_ID
                 , PORT_ID
                 , DETAIL_SEQ
                 , DETAIL_DIVISION
                 , DETAIL_TITLE
                 , DETAIL_CONTENT
                 )
            SELECT COALESCE(NULLIF(MAX(DETAIL_ID), 0), 0) + 1
                 , #{id}
                 , #{randomId}
                 , #{portId}
                 , COALESCE(NULLIF(MAX(DETAIL_SEQ), 0), 0) + 1
                 , #{detailDivision}
                 , #{detailTitle}
                 , #{detailContent}
              FROM PORTFOLIO_DETAIL
             WHERE ID	 		= #{id}
               AND RANDOM_ID 	= #{randomId}
               AND PORT_ID 		= #{portId}
        ]]>
    </insert>

    <select id="portfolioList" parameterType="PortfolioDto" resultType="PortfolioDto">
        <![CDATA[
            SELECT ID
                 , RANDOM_ID
                 , PORT_ID
                 , TITLE
                 , CONTENT
                 , CATEGORY_ID
                 , FILE_ID
                 , START_YMD
                 , END_YMD
            FROM PORTFOLIO
            WHERE ID 		= #{id}
              AND RANDOM_ID = #{randomId}
              AND PORT_ID 	= #{portId}
        ]]>
    </select>

    <select id="portfolioDetailList" parameterType="PortfolioDto" resultType="PortfolioDetailDto">
        <![CDATA[
            SELECT DETAIL_ID
                 , ID
                 , RANDOM_ID
                 , PORT_ID
                 , DETAIL_SEQ
                 , DETAIL_DIVISION
                 , DETAIL_TITLE
                 , DETAIL_CONTENT
            FROM PORTFOLIO_DETAIL
            WHERE ID 			= #{id}
              AND RANDOM_ID 	= #{randomId}
              AND PORT_ID 		= #{portId}
        ]]>
    </select>

    <update id="updatePortfolio" parameterType="PortfolioDto">
        <![CDATA[
            UPDATE PORTFOLIO
               SET TITLE        = #{title}
                 , CONTENT      = #{content}
                 , CATEGORY_ID  = #{categoryId}
                 , FILE_ID      = #{fileId}
                 , START_YMD    = #{startYmd}
                 , END_YMD      = #{endYmd}
             WHERE ID           = #{id}
               AND RANDOM_ID    = #{randomId}
               AND PORT_ID      = #{portId}
        ]]>
    </update>

    <delete id="deletePortfolio" parameterType="PortfolioDto">
        <![CDATA[
            DELETE FROM PORTFOLIO
             WHERE ID 			= #{id}
               AND RANDOM_ID 	= #{randomId}
               AND PORT_ID 		= #{portId}
        ]]>
    </delete>

    <delete id="deletePortfolioDetailAll" parameterType="PortfolioDto">
        <![CDATA[
            DELETE FROM PORTFOLIO_DETAIL
             WHERE ID 			= #{id}
               AND RANDOM_ID	= #{randomId}
               AND PORT_ID 		= #{portId}
        ]]>
    </delete>

</mapper>
